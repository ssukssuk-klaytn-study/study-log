# Klaytn Study 1주차 (2019.09.17)
- Klaytn 블록체인 구조 파악

## 기존 블록체인 플랫폼의 약점
- Scalability
참여하는 노드의 수와 성능이 비례하지 않음.

- Finality
확률론적 최종성만 제공하기 때문에 블록에 담긴 거래내용이 바뀔 수 없다는 것을 완벽하게 보증할 수 없음.
## Klaytn 이해하기

### [네트워크 구조]
이더리움과 같은 기존의 블록체인 플랫폼은 단일네트워크 구조와는 다르게 클레이튼은 계층화를 통해 크게 두단계, Core Cell Network와 Endpoint Node Network로 나누었음.

1. Core Cell Network
Core Cell 은 합의를 담당하는 노드(Consensus Node, 이하 CN) 하나와 Endpoint Node(이하 EN)와의 연결을 담당하는 노드(Proxy Node, 이하 PN) 여러개로 이루어져 있음. 
	- CNN(Consensus Node Network)
	> 합의하는 과정에 참여하는 대상들 전체와 의사소통을 빠르게 해야하기 때문에 모두 연결된 구조를 갖고 있음. 
	
	- PNN(Proxy Network)
	> CN의 빠른 합의 속도를 위해 외부의 방해가 없는 Private한 공간이 필요하여 존재하는 노드들의 집합. PN은 CN이 신뢰할 수 있는 노드로 EN을 앞에 내세워 EN과 접촉함.

3. ENN(Endpoint Node Network)
	> PN과 서로 신속하고 신뢰도 높은 블록을 주고 받음. EN은 서비스의 웹이나 모바일과 같은 클라인트들에게 정보를 전달하는, 다시 말해 서비스 제공자로서의 역할을 하는 노드임.

3. CN/ PN/ EN Bootnode
	> 새로 들어온 노드를 네트워크에 등록하고 다른 노드와 연결할 수 있도록 도와주는 특수 유형의 노드임. **CN Bootnode**는 공개되지 않음. **PN Bootnode**는 허용된 PN들만 등록할 수 있게 해주고 EN과 연결할 수 있도록 도와줌. 마지막으로, **EN Bootnode**는 어떤 PN과 연결해야하는지를 EN들에게 전달하는 역할을 함.


### [IBFT]
클레이튼의 합의 알고리즘으로, 크게 3단계를 거쳐 합의에 도달함.
1. Pre-Prepare 단계
> Proposer로 선정된 한 노드(Proposer)가 블록을 만들어 이를 나머지 노드들(Validator)에게 제안을 함
2. Prepare 단계
> Validator들은 제안 메세지를 잘 받으면 ACK와 같은 개념으로 자신을 제외한 모든 노드들에게 잘 받았다는 메세지를 보내줌.
3. Commit 단계
> Validator들이 다른 노드들과 소통하면서 제안을 수락할지 결정하는 단계임. 제안이 괜찮다고 생각하는지 아닌지에 대한 답을 다른 노드들에게 알림. 전체 의견 중 2/3 이상이 합의하면 블록을 승인하고 다음 단계로 넘어감.

이렇게 해서 Finality의 부재가 없고 변경 불가능한 최종적인 상태가 마무리됨. 앞의 이더리움의 POW(Proof-Of-Work)같이 애매모호한 상태로 마무리가 되는 것이 아님. 다시 말해, 노드끼리 통신을 통해 합의를 이끌어내고 그 즉시 완결성을 가짐. 그러나 노드의 수가 늘어날수록 통신량이 기하급수적으로 늘어나는데 이런 경우에는 전체 노드 중 일부만 뽑아서 BFT형태를 유지하도록 함.

### [블록 생성 및 전파]
Klaytn 블록의 생성주기를 라운드(Round)라고 하는데, 각 라운드는 새로운 블록을 생성하고 끝나는 즉시, 새로운 라운드가 시작됨. 블록 생성 간격은 약 1초정도 걸림.

- 블록 생성
> 제안자는 Governance Council 노드들 중 무작위(Randomly)  & 결정론적(Deterministically)으로 선택하는데, 여기서 Governance Council은 CN의 집합(CNN)을 의미함. 제안자로 선택이 되면, 자신이 그 라운드에서 제안자로 뽑혔다는 것을 자신의 공개키를 통해 입증가능한 암호증명을 하여 나머지 노드들에게 알림. Validator역시 마찬가지 방법으로 제안자에게 자신이 위원회로 뽑혔다는 것을 암호증명을 통해 파악시킴. 이후 누가 제안자고 누가 위원회인지 파악이 되면 제안자가 블록을 만들고 합의과정에 들어감.

- 블록 전파
> 위원회의 합의가 이끌어지면 PN을 통해 EN에게 까지 블록이 전달됨.
